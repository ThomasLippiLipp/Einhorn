<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Einhorn & Regenb√∂gen ‚Äì 2D Jump'n'Run</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<link rel="manifest" href="manifest.webmanifest">
<style>
  :root { --bg: #c7ecff; --ink: #222; --panel: #ffffffd8; --btn: #ffffffee; --btn-ink: #0e1a2a; }
  html, body { height: 100%; margin: 0; background: linear-gradient(#bfe9ff, #e8f7ff); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; color: var(--ink); }
  .wrap { display: grid; place-items: center; height: 100%; padding: max(12px, env(safe-area-inset-top)) max(12px, env(safe-area-inset-right)) max(12px, env(safe-area-inset-bottom)) max(12px, env(safe-area-inset-left)); box-sizing: border-box; }
  canvas { width: min(100%, 960px); height: auto; max-height: 80vh; display: block; border-radius: 16px; background: var(--bg); box-shadow: 0 20px 50px rgba(0,0,0,.15); touch-action: none; }
  .hud { position: fixed; inset: 12px; pointer-events: none; display: grid; grid-template-columns: 1fr auto; align-items: start; font-weight: 600; }
  .badge { background: var(--panel); backdrop-filter: blur(6px); border-radius: 12px; padding: 10px 12px; margin: 6px; box-shadow: 0 8px 22px rgba(0,0,0,.08); }
  .right { justify-self: end; }
  .kbd { font-family: ui-monospace, Menlo, Consolas, monospace; border: 1px solid #ddd; border-bottom-width: 3px; border-radius: 6px; padding: 2px 6px; background: #fff; margin: 0 2px; }
  .controls { position: fixed; inset-inline: 0; bottom: 0; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: calc(12px + env(safe-area-inset-bottom)); pointer-events: none; }
  .btn { pointer-events: auto; user-select: none; -webkit-tap-highlight-color: transparent; background: var(--btn); color: var(--btn-ink); border: 0; border-radius: 16px; box-shadow: 0 12px 30px rgba(0,0,0,.15); font-weight: 800; font-size: clamp(16px, 4vw, 22px); padding: 18px 16px; display: inline-flex; align-items: center; justify-content: center; gap: 10px; }
  .btn:active { transform: translateY(1px); }
  .btn--jump { min-height: 64px; }
  .btn--mini { font-size: 14px; padding: 12px 14px; border-radius: 12px; }
  .controls__left, .controls__right { display: grid; gap: 12px; }
  .controls__left { grid-template-columns: 1fr; padding-left: max(12px, env(safe-area-inset-left)); }
  .controls__right { grid-template-columns: 1fr; padding-right: max(12px, env(safe-area-inset-right)); }
  .row { display: grid; grid-auto-flow: column; gap: 12px; }
  @media (min-width: 740px) { canvas { max-height: 72vh; } .controls { gap: 16px; } }
  .startOverlay{ position:fixed; inset:0; display:grid; place-items:center; background:linear-gradient(#bfe9ffcc,#e8f7ffcc); backdrop-filter: blur(8px); }
  .startOverlay__inner{ background:#fff; padding:24px 20px; border-radius:16px; box-shadow:0 20px 50px rgba(0,0,0,.15); text-align:center; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial; }
  .startOverlay button{ margin-top:12px; font-weight:800; border:0; border-radius:12px; padding:14px 18px; box-shadow:0 12px 30px rgba(0,0,0,.15); }
</style>
</head>
<body>
<div class="wrap">
  <canvas id="game" width="960" height="540" aria-label="Einhorn Jump and Run"></canvas>
</div>
<div id="startOverlay" class="startOverlay">
  <div class="startOverlay__inner">
    <div style="font-size:22px; font-weight:800;">EINHORN & REGENB√ñGEN</div>
    <div style="opacity:.75; margin-top:6px">Tippe Start ‚Äì oder ü¶Ñ unten</div>
    <button id="startBtn">üöÄ Start</button>
  </div>
</div>
<div class="hud" aria-hidden="true">
  <div class="badge">
    <div><strong>Score:</strong> <span id="score">0</span></div>
    <div><strong>Beste:</strong> <span id="best">0</span></div>
  </div>
</div>
<div class="controls" role="group" aria-label="Touch-Steuerung">
  <div class="controls__left">
    <div class="row">
      <button class="btn btn--mini" id="pauseBtn" aria-label="Pause/Fortsetzen">‚è∏Ô∏è/‚ñ∂Ô∏è</button>
      <button class="btn btn--mini" id="restartBtn" aria-label="Neustart">üîÑ</button>
      <button class="btn btn--mini" id="fsBtn" aria-label="Vollbild">‚õ∂</button>
    </div>
  </div>
  <div class="controls__right">
    <button class="btn btn--jump" id="jumpBtn" aria-label="Springen">ü¶Ñ Springen</button>
  </div>
</div>

<script>
(() => {
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d', { alpha: false });
  const scoreEl = document.getElementById('score');
  const bestEl = document.getElementById('best');
  const jumpBtn = document.getElementById('jumpBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const restartBtn = document.getElementById('restartBtn');
  const startOverlay = document.getElementById('startOverlay');
  const startBtn = document.getElementById('startBtn');
  const fsBtn = document.getElementById('fsBtn');

  function fixHiDPI() {
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.round(rect.width * dpr);
    canvas.height = Math.round(rect.height * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }
  fixHiDPI(); new ResizeObserver(fixHiDPI).observe(canvas);

  const WORLD = { w:()=>canvas.clientWidth, h:()=>canvas.clientHeight, groundH:88, gravity:2600, jumpVel:1150, maxFall:2200, speed:360, speedMax:640, accel:10 };
  const keys=new Set(); const JUST_PRESSED=new Set();
  const press=(c)=>{ if(!keys.has(c)) JUST_PRESSED.add(c); keys.add(c); };
  const release=(c)=>{ keys.delete(c); };
  addEventListener('keydown', e=>{ const code = e.code==='KeyW'?'ArrowUp':e.code; if(['Space','ArrowUp'].includes(code)) e.preventDefault(); press(code); });
  addEventListener('keyup', e=>{ const code = e.code==='KeyW'?'ArrowUp':e.code; release(code); });

  // --- Touch + Start ---
  function startGameNow(){ resetGame(); if (startOverlay) startOverlay.style.display='none'; }
  canvas.addEventListener('touchstart', (e)=>{ e.preventDefault(); if(state===STATE.MENU) startGameNow(); else press('ArrowUp'); }, {passive:false});
  canvas.addEventListener('touchend',   (e)=>{ e.preventDefault(); release('ArrowUp'); }, {passive:false});
  startBtn.addEventListener('click', startGameNow);

  // Jump btn
  const touchPress=(c)=>(ev)=>{ ev.preventDefault(); press(c); };
  const touchRelease=(c)=>(ev)=>{ ev.preventDefault(); release(c); };
  jumpBtn.addEventListener('touchstart', touchPress('ArrowUp'), {passive:false});
  jumpBtn.addEventListener('touchend',   touchRelease('ArrowUp'), {passive:false});
  jumpBtn.addEventListener('click', ()=>{ press('ArrowUp'); setTimeout(()=>release('ArrowUp'),60); });

  // Pause/Restart
  const togglePause=()=>{ JUST_PRESSED.add('KeyP'); };
  const doRestart = ()=>{ JUST_PRESSED.add('KeyR'); };
  pauseBtn.addEventListener('touchstart', e=>{e.preventDefault();togglePause();},{passive:false});
  pauseBtn.addEventListener('click', togglePause);
  restartBtn.addEventListener('touchstart', e=>{e.preventDefault();doRestart();},{passive:false});
  restartBtn.addEventListener('click', doRestart);

  // Fullscreen
  async function goFullscreen(){
    const el = document.documentElement;
    try{
      if (document.fullscreenElement) await document.exitFullscreen();
      else if (el.requestFullscreen) await el.requestFullscreen();
    }catch(e){}
  }
  fsBtn.addEventListener('click', e=>{e.preventDefault();goFullscreen();});
  fsBtn.addEventListener('touchstart', e=>{e.preventDefault();goFullscreen();},{passive:false});

  // Utils
  const rand=(a,b)=>Math.random()*(b-a)+a;
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const now=()=>performance.now()/1000;

  class Particle{ constructor(x,y,vx,vy,life){ this.x=x;this.y=y;this.vx=vx;this.vy=vy;this.life=this.life0=life;this.size=rand(2,5);this.h=rand(270,320);} update(dt){ this.life-=dt; this.x+=this.vx*dt; this.y+=this.vy*dt; this.vy+=120*dt;} draw(ctx){ const a=clamp(this.life/this.life0,0,1); ctx.save(); ctx.globalAlpha=a; ctx.fillStyle=`hsl(${this.h}deg 90% 70%)`; ctx.beginPath(); ctx.arc(this.x,this.y,this.size*a,0,Math.PI*2); ctx.fill(); ctx.restore(); } }
  class Unicorn{
    constructor(){ this.reset(); }
    reset(){ this.x=140; this.y=this.groundY(); this.vy=0; this.w=64; this.h=42; this.onGround=true; this.coyote=0; this.jumpBuffer=0; this.holdJump=false; this.animT=0; this.particles=[]; }
    groundY(){ return WORLD.h()-WORLD.groundH-this.h; }
    tryJump(){ if(this.coyote>0||this.onGround){ this.vy=-WORLD.jumpVel; this.onGround=false; this.coyote=0; this.holdJump=true; for(let i=0;i<18;i++){ const ang=rand(-Math.PI,0), spd=rand(80,320); this.particles.push(new Particle(this.x+this.w*0.3,this.y+this.h*0.8,Math.cos(ang)*spd,Math.sin(ang)*spd,rand(0.3,0.7))); } } else { this.jumpBuffer=0.12; } }
    update(dt){
      if (JUST_PRESSED.has('Space') || JUST_PRESSED.has('ArrowUp')) this.tryJump();
      if (!keys.has('Space') && !keys.has('ArrowUp')) this.holdJump=false;
      this.vy+=WORLD.gravity*dt; if(this.vy>WORLD.maxFall) this.vy=WORLD.maxFall; this.y+=this.vy*dt;
      const gy=this.groundY();
      if (this.y>=gy){ this.y=gy; if(!this.onGround){ for(let i=0;i<10;i++){ this.particles.push(new Particle(this.x+this.w*0.2+rand(0,this.w*0.6),this.y+this.h,rand(-60,60),rand(-220,-60),rand(0.2,0.5))); } } this.onGround=true; this.vy=0; this.coyote=0.12; } else { this.coyote-=dt; if(!this.holdJump && this.vy<0){ this.vy+=1400*dt; } }
      if (this.jumpBuffer>0){ this.jumpBuffer-=dt; if(this.onGround){ this.tryJump(); this.jumpBuffer=0; } }
      this.particles=this.particles.filter(p=> (p.life-=0) || p.life>0); for(const p of this.particles) p.update(dt);
      this.animT+=dt*(this.onGround?clamp(WORLD.speed/300,0.8,2.2):1);
    }
    draw(ctx){
      for(const p of this.particles) p.draw(ctx);
      ctx.save(); ctx.translate(this.x,this.y);
      const t=this.animT, bob=Math.sin(t*10)*(this.onGround?2:1); ctx.translate(0,bob);
      // Schatten
      ctx.save(); ctx.globalAlpha=0.2; const shW=this.w*0.8, shH=10, shX=this.w*0.5, gy=WORLD.h()-WORLD.groundH, d=gy-(this.y+this.h), a=clamp(1-d/200,0.2,1); ctx.fillStyle='#000'; ctx.globalAlpha*=a; ctx.beginPath(); ctx.ellipse(shX,this.h+4+d*0.08,shW,shH,0,0,Math.PI*2); ctx.fill(); ctx.restore();
      // M√§hne
      const mane=['#ff0048','#ff7a00','#ffd500','#00c853','#00b0ff','#7c4dff']; for(let i=0;i<mane.length;i++){ ctx.fillStyle=mane[i]; ctx.fillRect(10,10+i*4,26,3); }
      // K√∂rper & Kopf
      ctx.fillStyle='#fff'; roundRect(ctx,0,12,this.w*0.75,this.h*0.6,12,true); roundRect(ctx,this.w*0.6,4,this.w*0.35,this.h*0.45,10,true);
      // Auge
      ctx.fillStyle='#222'; ctx.beginPath(); ctx.arc(this.w*0.86,this.h*0.22,3,0,Math.PI*2); ctx.fill();
      // Horn
      ctx.fillStyle='#f4c534'; ctx.beginPath(); ctx.moveTo(this.w*0.92,-6); ctx.lineTo(this.w*0.80,8); ctx.lineTo(this.w*1.00,8); ctx.closePath(); ctx.fill();
      // Beine
      ctx.fillStyle='#fff'; const step=Math.sin(t*12), legW=10, legH=22, baseY=this.h*0.72;
      drawLeg(this.w*0.12, baseY, step); drawLeg(this.w*0.34, baseY, -step); drawLeg(this.w*0.50, baseY, step); drawLeg(this.w*0.66, baseY, -step);
      function drawLeg(x,y,s){ ctx.save(); ctx.translate(x,y); ctx.rotate(s*0.2); roundRect(ctx,-legW/2,0,legW,legH,4,true); ctx.fillStyle='#d9d9d9'; roundRect(ctx,-legW/2,legH-5,legW,6,3,true); ctx.restore(); }
      ctx.restore();
    }
    getAABB(){ return { x:this.x+6, y:this.y+6, w:this.w*0.85, h:this.h*0.85 }; }
  }

  class Rainbow{ constructor(x){ this.w=rand(90,140); this.h=rand(120,200); this.thickness=16; this.x=x; this.y=WORLD.h()-WORLD.groundH-this.h; this.passed=false; this.colors=['#ff0048','#ff7a00','#ffd500','#00c853','#00b0ff','#7c4dff']; }
    update(dt){ this.x-=WORLD.speed*dt; } offscreen(){ return this.x+this.w<-50; } aabb(){ return {x:this.x,y:this.y,w:this.w,h:this.h}; }
    draw(ctx){ ctx.save(); ctx.translate(this.x+this.w/2, this.y+this.h); const rOuter=Math.min(this.w/2,this.h); ctx.lineCap='round';
      for(let i=0;i<this.colors.length;i++){ ctx.beginPath(); ctx.strokeStyle=this.colors[i]; ctx.lineWidth=this.thickness; const r=rOuter - i*(this.thickness+2); ctx.arc(0,0,r,Math.PI,0,false); ctx.stroke(); }
      ctx.fillStyle=this.colors[0]+'cc'; ctx.fillRect(-rOuter,-this.thickness/2,this.thickness,this.thickness); ctx.fillRect(rOuter-this.thickness,-this.thickness/2,this.thickness,this.thickness);
      ctx.restore();
    }
  }
  class Cloud{ constructor(){ this.reset(true);} reset(initial=false){ this.y=rand(30,180); this.x=initial?rand(0,WORLD.w()):WORLD.w()+rand(40,300); this.v=rand(20,60); this.scale=rand(0.6,1.4);} update(dt){ this.x-=this.v*dt; if(this.x<-200) this.reset(); } draw(ctx){ ctx.save(); ctx.translate(this.x,this.y); ctx.scale(this.scale,this.scale); ctx.globalAlpha=0.8; ctx.fillStyle='#fff'; blob(0,0,60,30); blob(40,-10,50,26); blob(-40,-6,40,24); ctx.restore(); function blob(x,y,w,h){ ctx.beginPath(); ctx.ellipse(x,y,w,h,0,0,Math.PI*2); ctx.fill(); } } }
  class Grass{ constructor(x){ this.x=x; this.y=WORLD.h()-WORLD.groundH; this.w=rand(40,100); this.h=rand(6,16); this.shade=rand(0.35,0.55);} update(dt){ this.x-=WORLD.speed*dt*0.9; } offscreen(){ return this.x+this.w<-10; } draw(ctx){ ctx.fillStyle=`hsl(130deg 60% ${this.shade*100}%)`; roundRect(ctx,this.x,this.y-this.h,this.w,this.h,4,true); } }

  const STATE={MENU:0,PLAY:1,PAUSE:2,OVER:3}; let state=STATE.MENU;
  const unicorn=new Unicorn(); const clouds=Array.from({length:8}, ()=>new Cloud());
  let grasses=[], rainbows=[], spawnT=0, score=0, best=Number(localStorage.getItem('unicorn_best')||0);
  bestEl.textContent=best;

  function resetGame(){ state=STATE.PLAY; WORLD.speed=360; unicorn.reset(); grasses=[]; rainbows=[]; score=0; spawnT=0; scoreEl.textContent=0; }
  function spawnRainbow(){ const r=new Rainbow(WORLD.w()+rand(0,120)); rainbows.push(r); spawnT=rand(1.2,2.3); }
  function spawnGrassRow(){ let x=WORLD.w(); for(let i=0;i<4;i++) grasses.push(new Grass(x+i*rand(30,110))); }
  function roundRect(ctx,x,y,w,h,r,fill=true,stroke=false){ r=Math.min(r,w/2,h/2); ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); if(fill) ctx.fill(); if(stroke) ctx.stroke(); }
  function intersects(a,b){ return !(a.x+a.w<b.x || a.x>b.x+b.w || a.y+a.h<b.y || a.y>b.y+b.h); }
  function drawGround(ctx){ const gy=WORLD.h()-WORLD.groundH; const grad=ctx.createLinearGradient(0,gy-30,0,WORLD.h()); grad.addColorStop(0,'#73da6a'); grad.addColorStop(1,'#4fbf54'); ctx.fillStyle=grad; ctx.fillRect(0,gy,WORLD.w(),WORLD.groundH); ctx.fillStyle='#ffffffaa'; ctx.fillRect(0,gy-2,WORLD.w(),2); }
  function drawTitle(ctx){ ctx.save(); ctx.textAlign='center'; ctx.fillStyle='#1b2a3a'; ctx.font='700 42px system-ui, Segoe UI, Roboto, Arial'; ctx.fillText('EINHORN & REGENB√ñGEN', WORLD.w()/2, WORLD.h()/2 - 40); ctx.font='600 20px system-ui, Segoe UI, Roboto, Arial'; ctx.fillText('Tippe Start oder ü¶Ñ', WORLD.w()/2, WORLD.h()/2 + 10); ctx.fillText('Springe √ºber die Regenb√∂gen. Viel Gl√ºck!', WORLD.w()/2, WORLD.h()/2 + 40); ctx.restore(); }
  function drawPause(ctx){ ctx.save(); ctx.textAlign='center'; ctx.fillStyle='#1b2a3a'; ctx.font='700 36px system-ui, Segoe UI, Roboto, Arial'; ctx.fillText('PAUSE', WORLD.w()/2, WORLD.h()/2 - 10); ctx.font='600 18px system-ui, Segoe UI, Roboto, Arial'; ctx.fillText('Tippe ‚è∏Ô∏è/‚ñ∂Ô∏è zum Fortfahren', WORLD.w()/2, WORLD.h()/2 + 24); ctx.restore(); }
  function drawGameOver(ctx){ ctx.save(); ctx.textAlign='center'; ctx.fillStyle='#1b2a3a'; ctx.font='700 40px system-ui, Segoe UI, Roboto, Arial'; ctx.fillText('GAME OVER', WORLD.w()/2, WORLD.h()/2 - 40); ctx.font='600 20px system-ui, Segoe UI, Roboto, Arial'; ctx.fillText(`Score: ${score}  ‚Ä¢  Beste: ${best}`, WORLD.w()/2, WORLD.h()/2 + 0); ctx.fillText('Tippe üîÑ f√ºr Neustart', WORLD.w()/2, WORLD.h()/2 + 36); ctx.restore(); }

  let last=now();
  function loop(){
    const t=now(); let dt=t-last; last=t; if(dt>0.05) dt=0.05;

    if(state===STATE.PLAY){
      WORLD.speed=clamp(WORLD.speed+WORLD.accel*dt,300,WORLD.speedMax);
      spawnT-=dt; if(spawnT<=0) spawnRainbow();
      if(Math.random()<0.02) spawnGrassRow();
      for(const c of clouds) c.update(dt);
      for(const g of grasses) g.update(dt); grasses=grasses.filter(g=>!g.offscreen());
      for(const r of rainbows) r.update(dt); rainbows=rainbows.filter(r=>!r.offscreen());
      unicorn.update(dt);

      for(const r of rainbows){ if(!r.passed && r.x+r.w < unicorn.x){ r.passed=true; score+=1; scoreEl.textContent=score; } }
      const a=unicorn.getAABB(); for(const r of rainbows){ if(intersects(a, r.aabb())){ state=STATE.OVER; best=Math.max(best,score); localStorage.setItem('unicorn_best', String(best)); bestEl.textContent=best; break; } }
    }

    // Render
    ctx.fillStyle='#e8f7ff'; ctx.fillRect(0,0,canvas.clientWidth, canvas.clientHeight);
    const skyGrad=ctx.createLinearGradient(0,0,0,WORLD.h()); skyGrad.addColorStop(0,'#bfe9ff'); skyGrad.addColorStop(1,'#e8f7ff'); ctx.fillStyle=skyGrad; ctx.fillRect(0,0,WORLD.w(),WORLD.h());
    for(const c of clouds) c.draw(ctx);
    drawGround(ctx);
    for(const g of grasses) g.draw(ctx);
    for(const r of rainbows) r.draw(ctx);
    unicorn.draw(ctx);
    if(state===STATE.MENU) drawTitle(ctx); else if(state===STATE.PAUSE) drawPause(ctx); else if(state===STATE.OVER) drawGameOver(ctx);

    JUST_PRESSED.clear();
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // State input
  addEventListener('click', ()=> canvas.focus({preventScroll:true}));
  canvas.tabIndex=0;
  canvas.addEventListener('keydown', e=>{ if(e.code) press(e.code); });
  canvas.addEventListener('keyup', e=>{ if(e.code) release(e.code); });
  addEventListener('keydown', e=>{
    if (e.code==='KeyP'){ if(state===STATE.PLAY) state=STATE.PAUSE; else if(state===STATE.PAUSE) state=STATE.PLAY; }
    if (e.code==='KeyR'){ resetGame(); }
    if (e.code==='Space' || e.code==='ArrowUp'){ if(state===STATE.MENU){ startGameNow(); } }
  });

  // PWA SW
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
    });
  }
})();
</script>
</body>
</html>
